<!DOCTYPE html>
<html class="x-admin-sm">

<head>
    <meta charset="UTF-8">
    <title>TRPG-MEMBER INFO</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <link rel="stylesheet" href="../../resource/css/xadmin/font.css">
    <link rel="stylesheet" href="../../resource/css/xadmin/xadmin.css">
    <script src="../../resource/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../resource/lib/xadmin.js"></script>
    <script type="text/javascript" src="../../resource/lib/jquery.min.js"></script>
    <script type="text/javascript" src="../js/fileSaver.js"></script>

    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

<div class="x-nav">
    <button class="layui-btn" onclick='downloadTextFile()'>导出消息记录文件</button>
    <span class="layui-breadcrumb">
          </span>
    <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right"
       onclick="location.reload()" title="刷新">
        <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i></a>

</div>

<div class="layui-fluid">
    <table id="messageList"></table>
</div>

</body>

<script type="text/html" id="createTimeHtml">
    {{# var date = new Date(d.time); var times= function(){ return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds(); }}} {{times()}}
</script>

<script type="text/html" id="messageHtml">
    <div style="width: 200px;">
        {{# if(d.messageType == 13){ }}
        <a style="color: blue;" href="{{d.message}}">{{d.message}}</a>
        {{# } if(d.messageType == 11){ }}
        <img width="100%" height="100%" src="{{d.message}}"/> {{# } if(d.messageType == 10) { }}
        <audio controls="" src="{{d.message}}"></audio>
        {{# } if(d.messageType == 1|| d.messageType == 2){ }} {{d.message}} {{#}}}

    </div>
</script>

<script>
    var findMemberId;
    var record;
    $(location).ready(function () {
        findMemberId = window.location.search;
        loadMessageRecord();
    });

    function downloadTextFile() {
        var mobileCode = JSON.stringify(record);
        //mobileCode 为写入文件的内容，可以通过获取文本框的value写入
        var file = new File([mobileCode], "record.json", {
            type: "text/plain;charset=utf-8"
        });
        saveAs(file);
    }

    function loadMessageRecord() {
        layui.use('table', function () {
            var table = layui.table;
            $.ajax({
                type: "get",
                url: "http://localhost/findRoomMessageRecord" + findMemberId,
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                success: function (result) {
                    var data = result.data;
                    var mapData = {};
                    record = result.data;
                    for (var i = 0; i < data.length; i++) {
                        mapData[data[i].id] = data[i];
                    }
                    window.RoomInfoData = mapData;
                    table.render({
                        elem: '#messageList',
                        page: true,
                        data: data,
                        cols: [
                            [{
                                field: 'time',
                                title: '创建时间',
                                width: 150,
                                templet: '#createTimeHtml'
                            }, {
                                field: 'nike',
                                title: '发送人昵称',
                                width: 100,
                                sort: true
                            }, {
                                field: 'message',
                                title: '消息文本',
                                width: 200,
                                sort: true,
                                templet: '#messageHtml'

                            }, {
                                field: 'memberId',
                                title: '发送人ID',
                                width: 100,
                                sort: true
                            }]
                        ]
                    });
                }
            });

        });
    }
</script>

</html>