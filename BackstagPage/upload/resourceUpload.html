<!doctype html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<title>资源上传</title>
		<script type="text/javascript" src="../../resource/lib/jquery.min.js"></script>
		<link rel="stylesheet" href="../lib/layui/css/layui.css" />
		<script type="text/javascript" src="../../resource/lib/layui/layui.js"></script>
		<link rel="stylesheet" href="../lib/layui/css/modules/layer/default/layer.css" />
		<script type="text/javascript" src="../lib/layui/lay/modules/layer.js"></script>
		<style>
			h1,
			h2 {
				font-weight: normal;
			}
			
			#msg {
				margin-top: 10px;
			}
		</style>
	</head>

	<body>

		<h1>资源上传</h1>
		<p>资源仅会保存1天，1天之后会自动清除资源.仅供测试使用</p>
		<p>如果是需要长期保留，推荐使用腾讯云对象存储等第三方平台提供，现在依旧是免费使用</p>
		<p>同时推荐使用网络资源，例如网页上面的某些图片，使用相关的url链接</p>

		<input id="fileSelector" type="file" onchange="fileChange(this);">

		<div style="max-width: 300px;" class="layui-progress" lay-filter="uploadProgress">
			<div class="layui-progress-bar layui-bg-blue" lay-percent="0%"></div>
		</div>

		<input class="layui-btn" id="submitBtn" type="submit">

		<div id="msg">

		</div>
		<input id="resultUrl" onclick="this.select();document.execCommand('copy');layer.msg('链接已复制');" class="layui-input" />
		<p>点击输入框自动复制</p>
		
		<script>
			var isIE = /msie/i.test(navigator.userAgent) && !window.opera;
			//注意进度条依赖 element 模块，否则无法进行正常渲染和功能性操作
			layui.use('element', function() {
				var element = layui.element;
			});

			(function() {

				// 请求用到的参数
				var Bucket = 'trpgpictrue-1257541903';
				var Region = 'ap-chengdu';
				var protocol = location.protocol === 'https:' ? 'https:' : 'http:';
				var prefix = protocol + '//' + Bucket + '.cos.' + Region + '.myqcloud.com/';
				var result;
				
				// 对更多字符编码的 url encode 格式
				var camSafeUrlEncode = function(str) {
					return encodeURIComponent(str)
						.replace(/!/g, '%21')
						.replace(/'/g, '%27')
						.replace(/\(/g, '%28')
						.replace(/\)/g, '%29')
						.replace(/\*/g, '%2A');
				};

				// 计算签名
				var getAuthorization = function(options, callback) {
					var url = 'http://localhost/post-policy?key=' + encodeURIComponent(options.Pathname);

					$.ajax({
						type: "get",
						url: url,
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						success: function(result) {
							if(result.code == 0) {
								credentials = result.data;
								callback(null, {
									Authorization: credentials
								});
							}
							if(result.code == 1) {
								alert(result.message);
							}
						}
					});
				};

				// 上传文件
				var uploadFile = function(file, callback) {
					var Key = file.name; // 这里指定上传目录和文件名
					getAuthorization({
						Method: 'PUT',
						Pathname: Key
					}, function(err, info) {

						if(err) {
							alert(err);
							return;
						}

						var auth = info.Authorization;
						var XCosSecurityToken = info.XCosSecurityToken;
						var url = prefix + camSafeUrlEncode(auth.key).replace(/%2F/, '/');
						var xhr = new XMLHttpRequest();
						xhr.open('PUT', url, true);
						xhr.setRequestHeader('Authorization', auth.singer);
						XCosSecurityToken && xhr.setRequestHeader('x-cos-security-token', XCosSecurityToken);
						xhr.upload.onprogress = function(e) {
							var progress = (Math.round(e.loaded / e.total * 10000) / 100) + '%';
							layui.use('element', function() {
								var element = layui.element;
								element.progress('uploadProgress', progress);

							});
							console.log('上传进度 ' + (Math.round(e.loaded / e.total * 10000) / 100) + '%');
						};
						xhr.onload = function() {
							if(/^2\d\d$/.test('' + xhr.status)) {
								var ETag = xhr.getResponseHeader('etag');
								callback(null, {
									url: url,
									ETag: ETag
								});
							} else {
								callback('文件 ' + Key + ' 上传失败，状态码：' + xhr.status);
							}
						};
						xhr.onerror = function() {
							callback('文件 ' + Key + ' 上传失败，请检查是否没配置 CORS 跨域规则');
						};
						xhr.send(file);
					});
				};

				// 监听表单提交
				document.getElementById('submitBtn').onclick = function(e) {
					var file = document.getElementById('fileSelector').files[0];
					if(!file) {
						document.getElementById('msg').innerText = '未选择上传文件';
						return;
					}
					file && uploadFile(file, function(err, data) {
						console.log(err || data);
						document.getElementById('msg').innerText = err ? err : ("上传成功，URL=");
						$("#resultUrl").val(data.url);
						changeParentText(data.url);
					});
				};
			})();
			
			function changeParentText(url){
				
				parent.$("textarea[name='"+ parent.TextInputName +"']").val(url);
				parent.$("input[name='"+ parent.TextInputName +"']").val(url);
				parent.$("img[name='"+ parent.TextInputName +"']").attr("src",url);
				//parent.$("input[name='mapsPictrueInput']").val(url);
				//parent.$("input[name='richUrlInput']").val(url);
			}

			function fileChange(target) {
				var fileSize = 0;
				if(isIE && !target.files) { // IE浏览器
					var filePath = target.value; // 获得上传文件的绝对路径
					var fileSystem = new ActiveXObject("Scripting.FileSystemObject");
					var file = fileSystem.GetFile(filePath);
					fileSize = file.Size; // 文件大小，单位：b
				} else { // 非IE浏览器
					fileSize = target.files[0].size;
				}
				var size = fileSize / 1024 / 1024;
				if(size > 2) {
					alert("附件不能大于2M");
				}
			}
		</script>

	</body>

</html>